<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buy First, Win Now!</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">

    <style>
        * {
            box-sizing: border-box;
        }

        body {
            background: url('background.png') no-repeat center center fixed;
            background-size: cover;
            font-family: 'Poppins', sans-serif;
            text-align: center;
            background-color: #f4f4f4;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            height: 100vh;
            margin: 0;
            padding: 0px;
            overflow: hidden;
            position: relative;
        }

        .title-container, .name-input-container, #result-display {
            max-height: 90vh;
            margin: 0px;
        }

        /* TITLE-CONTAINER */
        h1 {
            font-size: 100px;
            margin-top: auto;
            margin-bottom: auto;
            color: #ea3b52;
            font-weight: bold;
            text-shadow: 3px 3px 5px rgba(0, 0, 0, 0.2);
            white-space: nowrap;
        }

        .title-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 20px;
        }

        .main-logo {
            margin-top: 60px;
            width: 120px;
            height: auto;
            object-fit: contain;
        }

        /* WHEEL CONTAINER */
        #wheel-container {
            width: 400px;
            height: 400px;
            position: relative;
            margin: 60px auto;
        }

        #drawing_canvas {
            cursor: grab;
        }

        #drawing_canvas:active {
            cursor: grabbing;
        }

        /* RESULT DISPLAY */
        #result-display {
            width: 100%;
            height: 250px;
            line-height: 80px;
            font-size: 90px;
            font-weight: 900;
            background: #EA3B52;
            color: white;
            padding: 30px;
            border-radius: 0px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 120px;
            text-transform: uppercase;
            letter-spacing: 3px;
            transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
            box-shadow: 0 10px 20px rgba(234, 59, 82, 0.5);
            animation: pulse 2s infinite alternate;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 10px rgba(234, 59, 82, 0.7);
            }
            100% {
                box-shadow: 0 0 20px rgba(234, 59, 82, 1);
            }
        }

        #result-display.updated {
            transform: scale(1.1);
        }

        /* NAME AND DROPDOWN */
        .name-input-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 70px;
            margin-bottom: 60px;
        }

        /* DROPDOWN SELECTOR */
        #branch_id {
            margin-bottom: 30px;
            padding: 15px;
            font-size: 20px;
            border: 2px solid #ddd;
            border-radius: 10px;
            width: 80%;
            max-width: 500px;
            background-color: #fff;
            cursor: pointer;
            transition: 0.3s ease;
            appearance: none;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            min-height: 50px;
            margin-left: -60px;
            margin-top: 10px;
        }

        #branch_id:focus {
            border-color: #86be4e;
            outline: none;
            box-shadow: 0 0 5px rgba(134, 190, 70, 0.5);
        }

        #branch_id option {
            padding: 15px;
            background-color: #fff;
            font-size: 20px;
            text-align: center;
        }

        #branch_id:hover {
            border-color: #86be4e;
        }

        #branch_id:focus {
            background-color: #f9f9f9;
        }

        #branch_id option:hover {
            background-color: #f2f2f2;
        }

        /* NAME INPUT */
        #customer_name {
            margin-bottom: 20px;
            margin-left: -30px;
            padding: 15px;
            font-size: 20px;
            border-radius: 10px;
            border: 1px solid #ccc;
            width: 80%;
            max-width: 500px;
            min-height: 10px;
            appearance: none;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        label {
            font-size: 24px;
            margin-bottom: 15px;
            color: #333;
            text-transform: uppercase;
            letter-spacing: 1px;
            display: block;
            text-align: left;
            width: 100%;
        }

        #branch_id, #customer_name, label {
            margin-top: 20px;
            margin-bottom: -10px;
        }

        /* CONGRATULATION POPUP */
        #winnerMessage {
            font-size: 24px;
            font-weight: bold;
            margin-top: -90px;
        }

        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.4s ease, visibility 0.4s ease;
        }

        .popup-card {
            background: #fff;
            padding: 20px;
            width: 400px;
            max-width: 90%;
            border-radius: 12px;
            box-shadow: 0px 10px 30px rgba(0, 0, 0, 0.2);
            transform: translateY(-20px);
            transition: transform 0.4s ease;
            position: relative;
            text-align: center;
        }

        .popup-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .popup-overlay.show .popup-card {
            transform: translateY(0);
        }

        .close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #333;
            z-index: 1;
        }

        .popup-content i {
            width: 200px;
            height: 200px;
            margin-top: 20px;
        }

        /* 55 INCH SCREEN*/
        @media screen and (max-width: 3840px) {
            body {
                background: contain;
            }

            h1 {
                font-size: 90px;
            }

            #result-display {
                font-size: 70px;
                height: 380px;
                min-height: 200px;
                margin-bottom: -20px;
            }

            #customer_name, #branch_id {
                font-size: 20px;
            }

            .main-logo {
                width: 100px;
                margin-top: 20px;
            }

            .title-container {
                gap: 0px;
            }

            .name-input-container {
                gap: 50px;
            }
        }

        @keyframes shine {
            0% {
                transform: translateX(-100%);
            }
            100% {
                transform: translateX(200%);
            }
        }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="title-container">
            <img src="FES-LOGO/main-logo.png" alt="logo" class="main-logo" id="main-logo">
            <h1>BUY FIRST, WIN NOW!</h1>
        </div>
    </div>

    <div class="name-input-container">
        <div>
            <label for="customer_name">Enter your name:</label>
            <input type="text" id="customer_name" required inputmode="text" autocomplete="name">
        </div>
        
        <div>
            <label for="branch_id">Select Branch:</label>
            <select id="branch_id">
                <option value="1">Batu Satu Branch</option>
                <option value="2">Madang Branch</option>
            </select>
        </div>
    </div>

    <div id="wheel-container">
        <canvas id="drawing_canvas"></canvas>
    </div>

    <div id="result-display">SPIN THE WHEEL!</div>

    <div id="winnerPopup" class="popup-overlay">
        <div class="popup-card">
            <span class="close-btn">&times;</span>
            <div class="popup-content">
                <i class="fas fa-gift" style="font-size: 100px; color: #EA3B52;"></i>
                <p id="winnerMessage"></p>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/p2.js/0.6.0/p2.min.js"></script>
    <script>
        // Prize data (simulating your original system)
        let prizes = [
            { name: "Gold Prize M1", category: "gold", probability: 5, quantity: 2 },
            { name: "Gold Prize B2", category: "gold", probability: 5, quantity: 1 },
            { name: "Silver Prize M2", category: "silver", probability: 15, quantity: 5 },
            { name: "Silver Prize B1", category: "silver", probability: 15, quantity: 3 },
            { name: "Bronze Prize", category: "bronze", probability: 25, quantity: 10 },
            { name: "Complimentary Gift", category: "complimentary", probability: 35, quantity: 50 }
        ];

        // Wheel physics variables
        const TWO_PI = Math.PI * 2;
        var viewWidth = 400,
            viewHeight = 400,
            drawingCanvas = document.getElementById("drawing_canvas"),
            ctx,
            timeStep = (1/60);

        var ppm = 20, // pixels per meter
            physicsWidth = viewWidth / ppm,
            physicsHeight = viewHeight / ppm,
            physicsCenterX = physicsWidth * 0.5,
            physicsCenterY = physicsHeight * 0.5;

        var world, wheel, arrow, mouseBody, mouseConstraint;
        var arrowMaterial, pinMaterial, contactMaterial;
        var wheelSpinning = false, wheelStopped = true;
        var currentPrize = null;

        window.onload = function() {
            initDrawingCanvas();
            initPhysics();
            requestAnimationFrame(loop);
        };

        function initDrawingCanvas() {
            drawingCanvas.width = viewWidth;
            drawingCanvas.height = viewHeight;
            ctx = drawingCanvas.getContext('2d');

            drawingCanvas.addEventListener('mousemove', updateMouseBodyPosition);
            drawingCanvas.addEventListener('mousedown', checkStartDrag);
            drawingCanvas.addEventListener('mouseup', checkEndDrag);
            drawingCanvas.addEventListener('mouseout', checkEndDrag);
        }

        function updateMouseBodyPosition(e) {
            var p = getPhysicsCoord(e);
            mouseBody.position[0] = p.x;
            mouseBody.position[1] = p.y;
        }

        function checkStartDrag(e) {
            let customer_name = document.getElementById("customer_name");
            if (!customer_name || !customer_name.value.trim()) {
                alert("Please enter your name before spinning!");
                return;
            }

            if (world && mouseBody && wheel && world.hitTest(mouseBody.position, [wheel.body])[0]) {
                mouseConstraint = new p2.RevoluteConstraint(mouseBody, wheel.body, {
                    worldPivot: mouseBody.position,
                    collideConnected: false
                });
                world.addConstraint(mouseConstraint);
            }

            if (wheelSpinning === true) {
                wheelSpinning = false;
                wheelStopped = true;
                updateResultDisplay("Patience! Let it finish spinning.");
            }
        }

        function checkEndDrag(e) {
            if (mouseConstraint) {
                world.removeConstraint(mouseConstraint);
                mouseConstraint = null;

                if (wheelSpinning === false && wheelStopped === true) {
                    if (Math.abs(wheel.body.angularVelocity) > 5) {
                        wheelSpinning = true;
                        wheelStopped = false;
                        updateResultDisplay('SPINNING...');
                        selectRandomPrize();
                    } else {
                        updateResultDisplay('SPIN HARDER!');
                    }
                }
            }
        }

        function getPhysicsCoord(e) {
            var rect = drawingCanvas.getBoundingClientRect(),
                x = (e.clientX - rect.left) / ppm,
                y = physicsHeight - (e.clientY - rect.top) / ppm;
            return {x: x, y: y};
        }

        function initPhysics() {
            world = new p2.World();
            world.solver.iterations = 100;
            world.solver.tolerance = 0;

            arrowMaterial = new p2.Material();
            pinMaterial = new p2.Material();
            contactMaterial = new p2.ContactMaterial(arrowMaterial, pinMaterial, {
                friction: 0.0,
                restitution: 0.1
            });
            world.addContactMaterial(contactMaterial);

            var wheelRadius = 7,
                wheelX = physicsCenterX,
                wheelY = wheelRadius + 2,
                arrowX = wheelX,
                arrowY = wheelY + wheelRadius + 0.5;

            wheel = new Wheel(wheelX, wheelY, wheelRadius, 8, 0.2, 6.2);
            wheel.body.angle = (Math.PI / 16.5);
            arrow = new Arrow(arrowX, arrowY, 0.4, 1.2);
            mouseBody = new p2.Body();

            world.addBody(mouseBody);
        }

        function selectRandomPrize() {
            // Weight prizes by probability (same logic as original)
            let weightedPrizes = [];
            prizes.forEach(prize => {
                for (let i = 0; i < prize.probability; i++) {
                    weightedPrizes.push(prize);
                }
            });

            let randomIndex = Math.floor(Math.random() * weightedPrizes.length);
            currentPrize = weightedPrizes[randomIndex];
        }

        function update() {
            world.step(timeStep * 0.5);
            world.step(timeStep * 0.5);

            if (wheelSpinning === true && wheelStopped === false &&
                wheel.body.angularVelocity < 1 && arrow.hasStopped()) {

                wheelStopped = true;
                wheelSpinning = false;
                wheel.body.angularVelocity = 0;

                if (currentPrize) {
                    let customer_name = document.getElementById("customer_name").value;
                    let branch_id = document.getElementById("branch_id").value;
                    
                    showPrizeResult(currentPrize.name);
                    saveWinner(customer_name, currentPrize.name, branch_id, currentPrize.category);
                }
            }
        }

        function showPrizeResult(prizeName) {
            let display = document.getElementById("result-display");
            let finalText = prizeName.toUpperCase().split("");
            let chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
            let text = Array(finalText.length).fill("?");

            display.innerText = text.join("");

            // Rolling effect (same as original)
            let interval = setInterval(() => {
                for (let i = 0; i < text.length; i++) {
                    text[i] = chars[Math.floor(Math.random() * chars.length)];
                }
                display.innerText = text.join("");
            }, 50);

            setTimeout(() => {
                clearInterval(interval);
                display.innerText = finalText.join("");

                // Create a span for the pop effect (same as original)
                const resultText = document.createElement("span");
                resultText.innerText = display.innerText;
                resultText.style.display = "inline-block";
                resultText.style.transition = "transform 0.3s ease";
                display.innerHTML = "";
                display.appendChild(resultText);

                // Adding shine effect (same as original)
                resultText.style.position = "relative";

                const shineEffect = document.createElement("span");
                shineEffect.style.position = "absolute";
                shineEffect.style.top = "0";
                shineEffect.style.left = "0";
                shineEffect.style.width = "100%";
                shineEffect.style.height = "100%";
                shineEffect.style.background = "linear-gradient(90deg, rgba(255,255,255,0) 0%, rgba(255,255,255,0.8) 50%, rgba(255,255,255,0) 100%)";
                shineEffect.style.opacity = "0.5";
                shineEffect.style.pointerEvents = "none";
                shineEffect.style.animation = "shine 1s forwards";
                resultText.appendChild(shineEffect);

                // Adding a slight bounce effect (same as original)
                setTimeout(() => {
                    resultText.style.transform = "scale(1.2)";
                    setTimeout(() => {
                        resultText.style.transform = "scale(1)";
                        launchConfetti();

                        setTimeout(() => {
                            showWinnerPopup();
                        }, 3000);
                    }, 150);
                }, 150);
            }, 2000);
        }

        function updateResultDisplay(text) {
            const resultDisplay = document.getElementById("result-display");
            if (resultDisplay) {
                resultDisplay.innerText = text;
            }
        }

        function draw() {
            ctx.clearRect(0, 0, viewWidth, viewHeight);
            wheel.draw();
            arrow.draw();
        }

        function loop() {
            update();
            draw();
            requestAnimationFrame(loop);
        }

        // Wheel Constructor
        function Wheel(x, y, radius, segments, pinRadius, pinDistance) {
            this.x = x;
            this.y = y;
            this.radius = radius;
            this.segments = segments;
            this.pinRadius = pinRadius;
            this.pinDistance = pinDistance;

            this.pX = this.x * ppm;
            this.pY = (physicsHeight - this.y) * ppm;
            this.pRadius = this.radius * ppm;
            this.pPinRadius = this.pinRadius * ppm;
            this.pPinPositions = [];

            this.deltaPI = TWO_PI / this.segments;

            this.createBody();
            this.createPins();
        }

        Wheel.prototype = {
            createBody: function() {
                this.body = new p2.Body({mass: 1, position: [this.x, this.y]});
                this.body.angularDamping = 0.0;
                this.body.addShape(new p2.Circle(this.radius));
                this.body.shapes[0].sensor = true;

                var axis = new p2.Body({position: [this.x, this.y]});
                var constraint = new p2.LockConstraint(this.body, axis);
                constraint.collideConnected = false;

                world.addBody(this.body);
                world.addBody(axis);
                world.addConstraint(constraint);
            },

            createPins: function() {
                var pin = new p2.Circle(this.pinRadius);
                pin.material = pinMaterial;

                for (var i = 0; i < this.segments; i++) {
                    var x = Math.cos(i / this.segments * TWO_PI) * this.pinDistance,
                        y = Math.sin(i / this.segments * TWO_PI) * this.pinDistance;

                    this.body.addShape(pin, [x, y]);
                    this.pPinPositions[i] = [x * ppm, -y * ppm];
                }
            },

            draw: function() {
                ctx.save();
                ctx.translate(this.pX, this.pY);

                // Draw wheel base
                ctx.beginPath();
                ctx.fillStyle = '#DB9E36';
                ctx.arc(0, 0, this.pRadius + 20, 0, TWO_PI);
                ctx.fill();
                ctx.fillRect(-10, 0, 20, 350);

                ctx.rotate(-this.body.angle);

                // Draw segments with colors matching your brand
                var colors = ['#BD4932', '#FFFAD5', '#4A90BD', '#7CB342', '#FF8F00', '#8E24AA', '#D32F2F', '#689F38'];
                var labels = ['GOLD', 'SILVER', 'BRONZE', 'GIFT', 'GOLD', 'SILVER', 'BRONZE', 'GIFT'];
                
                for (var i = 0; i < this.segments; i++) {
                    ctx.fillStyle = colors[i % colors.length];
                    ctx.beginPath();
                    ctx.arc(0, 0, this.pRadius, i * this.deltaPI, (i + 1) * this.deltaPI);
                    ctx.lineTo(0, 0);
                    ctx.closePath();
                    ctx.fill();

                    // Add segment labels
                    ctx.save();
                    ctx.rotate((i + 0.5) * this.deltaPI);
                    ctx.fillStyle = '#fff';
                    ctx.font = 'bold 14px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText(labels[i], this.pRadius * 0.7, 3);
                    ctx.restore();
                }

                // Draw pins
                ctx.fillStyle = '#401911';
                this.pPinPositions.forEach(function(p) {
                    ctx.beginPath();
                    ctx.arc(p[0], p[1], this.pPinRadius, 0, TWO_PI);
                    ctx.fill();
                }, this);

                ctx.restore();
            }
        };

        // Arrow Constructor
        function Arrow(x, y, w, h) {
            this.x = x;
            this.y = y;
            this.w = w;
            this.h = h;
            this.verts = [];

            this.pX = this.x * ppm;
            this.pY = (physicsHeight - this.y) * ppm;
            this.pVerts = [];

            this.createBody();
        }

        Arrow.prototype = {
            createBody: function() {
                this.body = new p2.Body({mass: 1, position: [this.x, this.y]});
                this.body.addShape(this.createArrowShape());

                var axis = new p2.Body({position: [this.x, this.y]});
                var constraint = new p2.RevoluteConstraint(this.body, axis, {
                    worldPivot: [this.x, this.y]
                });
                constraint.collideConnected = false;

                var left = new p2.Body({position: [this.x - 1.5, this.y]});
                var right = new p2.Body({position: [this.x + 1.5, this.y]});
                var leftConstraint = new p2.DistanceConstraint(this.body, left, {
                    localAnchorA: [-this.w * 2, this.h * 0.25],
                    collideConnected: false
                });
                var rightConstraint = new p2.DistanceConstraint(this.body, right, {
                    localAnchorA: [this.w * 2, this.h * 0.25],
                    collideConnected: false
                });

                leftConstraint.setStiffness(32);
                leftConstraint.setRelaxation(4);
                rightConstraint.setStiffness(32);
                rightConstraint.setRelaxation(4);

                world.addBody(this.body);
                world.addBody(axis);
                world.addConstraint(constraint);
                world.addConstraint(leftConstraint);
                world.addConstraint(rightConstraint);
            },

            createArrowShape: function() {
                this.verts[0] = [0, this.h * 0.25];
                this.verts[1] = [-this.w * 0.5, 0];
                this.verts[2] = [0, -this.h * 0.75];
                this.verts[3] = [this.w * 0.5, 0];

                this.pVerts[0] = [this.verts[0][0] * ppm, -this.verts[0][1] * ppm];
                this.pVerts[1] = [this.verts[1][0] * ppm, -this.verts[1][1] * ppm];
                this.pVerts[2] = [this.verts[2][0] * ppm, -this.verts[2][1] * ppm];
                this.pVerts[3] = [this.verts[3][0] * ppm, -this.verts[3][1] * ppm];

                var shape = new p2.Convex(this.verts);
                shape.material = arrowMaterial;
                return shape;
            },

            hasStopped: function() {
                var angle = Math.abs(this.body.angle % TWO_PI);
                return (angle < 1e-3 || (TWO_PI - angle) < 1e-3);
            },

            draw: function() {
                ctx.save();
                ctx.translate(this.pX, this.pY);
                ctx.rotate(-this.body.angle);

                ctx.fillStyle = '#401911';
                ctx.beginPath();
                ctx.moveTo(this.pVerts[0][0], this.pVerts[0][1]);
                ctx.lineTo(this.pVerts[1][0], this.pVerts[1][1]);
                ctx.lineTo(this.pVerts[2][0], this.pVerts[2][1]);
                ctx.lineTo(this.pVerts[3][0], this.pVerts[3][1]);
                ctx.closePath();
                ctx.fill();

                ctx.restore();
            }
        };

        // Your original functions preserved exactly
        function launchConfetti() {
            confetti({
                particleCount: 500,
                spread: 100,
                startVelocity: 45,
                origin: { y: 0.6 },
                colors: ['#EA3B52', '#86BE4E', '#FFD700'],
            });
        }

        function showWinnerPopup() {
            let customerName = document.getElementById("customer_name").value;
            let prizeName = document.getElementById("result-display").innerText;
            let popup = document.getElementById("winnerPopup");
            let winnerMessageContainer = document.getElementById("winnerMessage");

            let winnerMessage = `<h2>Congratulations, ${customerName}! 🎉</h2>
                <p>You have won the <strong>${prizeName}</strong>!</p>`;

            if (winnerMessageContainer) {
                winnerMessageContainer.innerHTML = winnerMessage;
            }

            if (popup) {
                popup.classList.add("show");
            }

            // Close button functionality
            document.querySelectorAll(".close-btn").forEach(btn => {
                btn.onclick = function() {
                    popup.classList.remove("show");
                    resetGame();
                };
            });

            // Hide popup when clicking outside
            window.onclick = function (event) {
                if (event.target === popup) {
                    popup.classList.remove("show");
                    resetGame();
                }
            };
        }

        function resetGame() {
            const winnerMessage = document.getElementById("winnerMessage");
            const customerName = document.getElementById("customer_name");
            const resultDisplay = document.getElementById("result-display");
            
            if (winnerMessage) winnerMessage.innerHTML = "";
            if (customerName) customerName.value = "";
            if (resultDisplay) resultDisplay.innerText = "SPIN THE WHEEL!";
            currentPrize = null;
        }

        function saveWinner(customer_name, prize_name, branch_id, category) {
            // Simulate saving winner (replace with your PHP endpoint)
            console.log("Winner saved:", {
                customer_name: customer_name,
                prize_name: prize_name,
                branch_id: branch_id,
                category: category,
                timestamp: new Date().toISOString()
            });
        }

        // Fullscreen functionality (same as original)
        document.addEventListener("DOMContentLoaded", function () {
            const mainLogo = document.querySelector(".main-logo");

            function toggleFullScreen() {
                if (!document.fullscreenElement) {
                    document.documentElement.requestFullscreen().catch(err => {
                        console.log(`Error attempting to enable fullscreen: ${err.message}`);
                    });
                } else {
                    document.exitFullscreen();
                }
            }

            document.addEventListener("keydown", function (event) {
                if (event.key.toLowerCase() === "f") {
                    toggleFullScreen();
                }
            });

            if (mainLogo) {
                mainLogo.addEventListener("click", toggleFullScreen);
            }
        });
    </script>
</body>
</html>