<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin Dashboard BFWN</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; display: flex; background: #f0f2f5; }
    
    .sidebar { 
      width: 250px; 
      background: #2c3e50; 
      color: #fff; 
      height: 100vh; 
      padding: 20px; 
      box-shadow: 2px 0 5px rgba(0,0,0,0.1);
    }
    
    .sidebar h2 { 
      margin-bottom: 30px; 
      color: #ecf0f1; 
      border-bottom: 2px solid #34495e; 
      padding-bottom: 10px;
    }
    
    .sidebar a { 
      display: block; 
      color: #bdc3c7; 
      padding: 12px 15px; 
      margin: 5px 0; 
      text-decoration: none; 
      border-radius: 5px; 
      transition: all 0.3s;
    }
    
    .sidebar a:hover { background: #34495e; color: #fff; }
    .sidebar a.active { background: #3498db; color: #fff; }
    
    .main { 
      flex: 1; 
      padding: 30px; 
      background: #fff; 
      margin: 20px; 
      border-radius: 10px; 
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      padding-bottom: 15px;
      border-bottom: 2px solid #ecf0f1;
    }
    
    .branch-selector {
      padding: 8px 12px;
      border: 2px solid #3498db;
      border-radius: 5px;
      background: #fff;
      color: #2c3e50;
      font-weight: bold;
    }
    
    table { 
      width: 100%; 
      border-collapse: collapse; 
      margin-top: 20px; 
      background: #fff;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    th, td { 
      padding: 15px; 
      text-align: left; 
      border-bottom: 1px solid #ecf0f1;
    }
    
    th { 
      background: #34495e; 
      color: #fff; 
      font-weight: bold;
    }
    
    tr:hover { background: #f8f9fa; }
    
    .btn {
      padding: 8px 16px;
      margin: 3px;
      cursor: pointer;
      border: none;
      border-radius: 4px;
      font-weight: bold;
      transition: all 0.3s;
    }
    
    .btn-primary { background: #3498db; color: #fff; }
    .btn-recalculate { background: #27ae60; color: #fff; }
    .btn-primary:hover { background: #2980b9; }
    
    .btn-success { background: #27ae60; color: #fff; }
    .btn-success:hover { background: #219a52; }
    
    .btn-danger { background: #e74c3c; color: #fff; }
    .btn-danger:hover { background: #c0392b; }
    
    .btn-warning { background: #f39c12; color: #fff; }
    .btn-warning:hover { background: #d68910; }
    
    .category-gold { background: #f1c40f; color: #fff; padding: 4px 8px; border-radius: 12px; font-size: 0.8em; }
    .category-silver { background: #95a5a6; color: #fff; padding: 4px 8px; border-radius: 12px; font-size: 0.8em; }
    .category-complimentary { background: #27ae60; color: #fff; padding: 4px 8px; border-radius: 12px; font-size: 0.8em; }
    
    .section { display: none; }
    .section.active { display: block; }
    
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
    }
    
    .modal-content {
      background: #fff;
      padding: 30px;
      border-radius: 10px;
      width: 500px;
      margin: 50px auto;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }
    
    .form-group {
      margin-bottom: 15px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
      color: #2c3e50;
    }
    
    .form-group input, .form-group select {
      width: 100%;
      padding: 10px;
      border: 2px solid #bdc3c7;
      border-radius: 5px;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div class="sidebar">
    <h2>Admin Panel</h2>
    <a href="#" class="active" onclick="showSection('dashboard')">Dashboard</a>
    <a href="#" onclick="showSection('prizes')">Manage Prizes</a>
    <a href="#" onclick="showSection('wheelSettings')">Wheel Settings</a>
    <a href="#" onclick="showSection('spinLogs')">Spin Logs</a>
    <a href="#" onclick="showSection('analytics')">Analytics</a>
  </div>
  
  <div class="main">
    <div class="header">
      <h1 id="pageTitle">Dashboard</h1>
      <select class="branch-selector" id="branchSelector" onchange="switchBranch()">
        <option value="batu-satu">Batu Satu Branch</option>
        <option value="madang">Madang Branch</option>
      </select>
    </div>
    
    <!-- Dashboard Section -->
    <div id="dashboardSection" class="section active">
      <h2>System Overview</h2>
      <p>Welcome to admin side cuh</p>
    </div>
    
    <!-- Manage Prizes Section -->
    <div id="prizesSection" class="section">
      <button class="btn btn-success" onclick="openAddPrizeModal()">+ Add New Prize</button>

      <!-- filter tabs (active/inactive prizes) -->
      <div style="margin: 20px 0; display: flex; gap: 10px;">
        <button class="btn" id="filterAll" style="background: #3498db; color: white;" onclick="filterPrizes('all')">All Prizes</button>
        <button class="btn" id="filterActive" style="background: #ecf0f1; color: #2c3e50;" onclick="filterPrizes('active')">Active Only</button>
        <button class="btn" id="filterInactive" style="background: #ecf0f1; color: #2c3e50;" onclick="filterPrizes('inactive')">Inactive Only</button>
      </div>

      <!-- recalculate all prizes's probabilities -->
      <div style="margin: 10px 0; color: #86be4e;">
        <button class="btn btn-recalculate" onclick="recalculateAll()">Recalculate</button>
      </div>

      <table id="prizesTable">
        <thead>
          <tr>
            <th>Prize Name</th>
            <th>Category</th>
            <th>Quantity</th>
            <th>Probability (%)</th>
            <th>Status</th>
            <th>Active</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="prizesTableBody">
          <!-- Dynamic content -->
        </tbody>
      </table>
    </div>
    
    <!-- Wheel Settings Section -->
    <div id="wheelSettingsSection" class="section">
      <h2>Wheel Configuration</h2>
      <p>Configure wheel behavior, spin duration, and visual settings.</p>
      <!-- Will implement wheel settings here -->
    </div>
    
    <!-- Spin Logs Section -->
    <div id="spinLogsSection" class="section">
      <h2>Winner History</h2>
      
      <div style="margin-bottom: 20px;">
        <button class="btn btn-primary" onclick="refreshLogs()">Refresh</button>
        <button class="btn btn-warning" onclick="exportLogs()">Export CSV</button>
        <button class="btn btn-danger" onclick="clearLogs()">Clear All</button>
      </div>
      
      <table id="winnersTable">
        <thead>
          <tr>
            <th>Date/Time</th>
            <th>Customer Name</th>
            <th>Prize Won</th>
            <th>Category</th>
            <th>Receipt No.</th>
            <th>Branch</th>
          </tr>
        </thead>
        <tbody id="winnersTableBody">
          <!-- Dynamic content -->
        </tbody>
      </table>
    </div>
    
    <!-- Analytics Section -->
    <div id="analyticsSection" class="section">
      <h2>Analytics & Reports</h2>
      <p>View statistics and generate reports.</p>
      <!-- Will implement analytics here -->
    </div>
  </div>

  <!-- Add/Edit Prize Modal -->
  <div id="prizeModal" class="modal">
    <div class="modal-content">
      <h3 id="modalTitle">Add New Prize</h3>
      <form id="prizeForm">
        <div class="form-group">
          <label>Prize Name:</label>
          <input type="text" id="prizeName" required>
        </div>
        
        <div class="form-group">
          <label>Category:</label>
          <select id="prizeCategory" required>
            <option value="gold">Gold Prize</option>
            <option value="silver">Silver Prize</option>
            <option value="complimentary">Complimentary Gift</option>
          </select>
        </div>
        
        <div class="form-group">
          <label>Quantity:</label>
          <input type="number" id="prizeQuantity" min="0" required>
        </div>
        
        <div class="form-group">
          <label>Probability (%):</label>
          <input type="number" id="prizeProbability" min="0" max="100" step="0.1" required>
        </div>
        
        <div style="text-align: right; margin-top: 20px;">
          <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Prize</button>
        </div>
      </form>
    </div>
  </div>

<script>

  // Load from localStorage on page load
function loadFromLocalStorage() {
    const saved = localStorage.getItem('PRIZE_DATABASE');
    if (saved) {
        console.log('LOADING FROM LOCALSTORAGE:', saved);
        const savedData = JSON.parse(saved);
        
        Object.assign(PRIZE_DATABASE, savedData);
        console.log('LOADED WINNERS:', PRIZE_DATABASE.winners);
    }
}

// save to localStorage on pageload
function saveToLocalStorage() {

  localStorage.setItem('PRIZE_DATABASE', JSON.stringify(PRIZE_DATABASE));
  console.log("Admin: saved changes to local storage");
}

function autoCalculateProbabilities(editingPrizeId, newProbability) {
    const prizes = PRIZE_DATABASE.branches[currentBranch].prizes;
    const editingPrize = prizes.find(p => p.id === editingPrizeId);
    
    if (!editingPrize) return;
    
    // Set the edited prize to the new probability and lock it
    editingPrize.probability = parseFloat(newProbability); 

    const allPrizes = PRIZE_DATABASE.branches[currentBranch].prizes;
    allPrizes.forEach(prize => {
        if (prize.quantity === 0) {
            prize.active = false;
            prize.probability = 0;
            prize.available = false;
        }
    });
    
    // Calculate total locked probability
    const lockedPrizes = prizes.filter(p => p.locked && p.active && p.id !== editingPrizeId);
    const unlockedPrizes = prizes.filter(p => !p.locked && p.active && p.id !== editingPrizeId);
    const lockedTotal = lockedPrizes.reduce((sum, p) => sum + p.probability, 0) + editingPrize.probability;
    
    // Remaining probability for unlocked prizes
    const remainingProbability = 100 - lockedTotal;

    const categoryCounts = {
            gold: unlockedPrizes.filter(p => p.category === 'gold').length,
            silver: unlockedPrizes.filter(p => p.category === 'silver').length,
            complimentary: unlockedPrizes.filter(p => p.category === 'complimentary').length
        };

    //debug
    console.log('=== AUTO-CALCULATION DEBUG ===');
    console.log('Editing prize:', editingPrize.name, 'to', newProbability + '%');
    console.log('Locked prizes:', lockedPrizes.map(p => p.name + ': ' + p.probability + '%'));
    console.log('Unlocked prizes:', unlockedPrizes.map(p => p.name + ': ' + p.probability + '%'));
    console.log('Locked total:', lockedTotal + '%');
    console.log('Remaining for unlocked:', remainingProbability + '%');
    console.log('Category counts:', categoryCounts);
    
    if (remainingProbability < 0) {
        alert('Locked prizes exceed 100%. Please unlock some prizes.');
        return;
    }
    
    // Distribute remaining probability among unlocked prizes
    if (unlockedPrizes.length > 0) {
        
    
    // Group unlocked prizes by category
    const goldPrizes = unlockedPrizes.filter(p => p.category === 'gold');
    const silverPrizes = unlockedPrizes.filter(p => p.category === 'silver');
    const compPrizes = unlockedPrizes.filter(p => p.category === 'complimentary');

    // Distribute probability: Gold gets lowest share, Complimentary gets highest
    const goldShare = remainingProbability * 0.1;  // 10% of remaining
    const silverShare = remainingProbability * 0.2; // 20% of remaining
    const compShare = remainingProbability * 0.7;   // 70% of remaining

    // Distribute equally within each category
    if (goldPrizes.length > 0) {
        const perGold = goldShare / goldPrizes.length;
        goldPrizes.forEach(p => p.probability = parseFloat(perGold.toFixed(1)));
    }

    if (silverPrizes.length > 0) {
        const perSilver = silverShare / silverPrizes.length;
        silverPrizes.forEach(p => p.probability = parseFloat(perSilver.toFixed(1)));
    }

    if (compPrizes.length > 0) {
        const perComp = compShare / compPrizes.length;
        compPrizes.forEach(p => p.probability = parseFloat(perComp.toFixed(1)));
    }

    // Final adjustment distributed evenly across all complimentary gifts
    const activePrizes = prizes.filter(p => p.active);
    const currentTotal = activePrizes.reduce((sum, p) => sum + p.probability, 0);
    const adjustment = 100 - currentTotal;

    if (Math.abs(adjustment) > 0.01) {
      if (compPrizes.length > 0) {
       
        const adjustmentPerComp = adjustment / compPrizes.length;
        compPrizes.forEach(p => {
          p.probability = parseFloat((p.probability + adjustmentPerComp).toFixed(1));
        });
      } else if (silverPrizes.length > 0) {
        
        const adjustmentPerSilver = adjustment / silverPrizes.length;
        silverPrizes.forEach(p => {
          p.probability = parseFloat((p.probability + adjustmentPerSilver).toFixed(1));
        });
      } else if (goldPrizes.length > 0) {
        
        const adjustmentPerGold = adjustment / goldPrizes.length;
        goldPrizes.forEach(p => {
          p.probability = parseFloat((p.probability + adjustmentPerGold).toFixed(1));
        });
      }
    }

        console.log('===============================');
    }
    
    console.log('Auto-calculated with locked prizes');
}



window.addEventListener('storage', function(e) {
    if (e.key === 'PRIZE_DATABASE') {
        console.log('Storage updated, refreshing data...');
        loadFromLocalStorage();
        
        // Auto-refresh current section if it's spin logs
        const activeSection = document.querySelector('.section.active');
        if (activeSection && activeSection.id === 'spinLogsSection') {
            loadWinnerHistory();
        }
    }
});

setInterval(() => {
    const activeSection = document.querySelector('.section.active');
    if (activeSection && activeSection.id === 'spinLogsSection') {
        loadFromLocalStorage();
        loadWinnerHistory();
    }
}, 10000);

setInterval(() => {
    const activeSection = document.querySelector('.section.active');
    if (activeSection && activeSection.id === 'prizesSection') {
        loadFromLocalStorage();
        loadPrizesTable();
        console.log('Auto-refreshed prizes table');
    }
}, 5000);

// Call this when page loads
document.addEventListener('DOMContentLoaded', function() {
    loadFromLocalStorage();

    //restore last active session
    const savedSection = localStorage.getItem('currentSection') || 'dashboard';
    const savedSectionLink = document.querySelector(`a[onclick="showSection('${savedSection}')"]`);
    if (savedSectionLink) {
      savedSectionLink.click();
    }
});

const PRIZE_DATABASE = {
    branches: {
        'batu-satu': {
            id: 1,
            name: 'Batu Satu Branch',
            prizes: [
                { id: 'B2', name: 'Gold Prize B2', category: 'gold', quantity: 1, probability: 5, available: true, active: true, locked: false },
                { id: 'B3', name: 'Gold Prize B3', category: 'gold', quantity: 1, probability: 5, available: true, active: true, locked: false },
                { id: 'B1', name: 'Silver Prize B1', category: 'silver', quantity: 1, probability: 15, available: true, active: true, locked: false },
                { id: 'B4', name: 'Silver Prize B4', category: 'silver', quantity: 1, probability: 15, available: true, active: true, locked: false },
                { id: 'COMP1', name: 'Complimentary Gift 1', category: 'complimentary', quantity: 50, probability: 25, available: true, active: true, locked: false },
                { id: 'COMP2', name: 'Complimentary Gift 2', category: 'complimentary', quantity: 50, probability: 30, available: true, active: true, locked: false }
            ]
        },
        'madang': {
            id: 2,
            name: 'Madang Branch',
            prizes: [
                { id: 'M2', name: 'Gold Prize M1', category: 'gold', quantity: 1, probability: 5, available: true, active: true, locked: false },
                { id: 'M3', name: 'Gold Prize M4', category: 'gold', quantity: 1, probability: 5, available: true, active: true, locked: false },
                { id: 'M1', name: 'Silver Prize M2', category: 'silver', quantity: 1, probability: 15, available: true, active: true, locked: false },
                { id: 'M4', name: 'Silver Prize M3', category: 'silver', quantity: 1, probability: 15, available: true, active: true, locked: false },
                { id: 'COMP3', name: 'Complimentary Gift 3', category: 'complimentary', quantity: 50, probability: 25, available: true, active: true, locked: false },
                { id: 'COMP4', name: 'Complimentary Gift 4', category: 'complimentary', quantity: 50, probability: 30, available: true, active: true, locked: false }
            ]
        }
    },
    winners: [],
    
    getAvailablePrizes: function(branchKey) {
        if (!this.branches[branchKey]) return [];
        return this.branches[branchKey].prizes.filter(prize => prize.quantity > 0 && prize.available);
    },
    
    addPrize: function(branchKey, prizeData) {
        if (!this.branches[branchKey]) return false;
        
        const newPrize = {
            id: prizeData.id || 'P' + Date.now(),
            name: prizeData.name,
            category: prizeData.category,
            quantity: parseInt(prizeData.quantity),
            probability: parseFloat(prizeData.probability),
            available: true,
            active: true,
            locked: false,
        };
        
        this.branches[branchKey].prizes.push(newPrize);
        return true;
    },

    
    updatePrize: function(branchKey, prizeId, prizeData) {
        if (!this.branches[branchKey]) return false;
        
        const prize = this.branches[branchKey].prizes.find(p => p.id === prizeId);
        if (!prize) return false;
        
        prize.name = prizeData.name;
        prize.category = prizeData.category;
        prize.quantity = parseInt(prizeData.quantity);
        prize.probability = parseFloat(prizeData.probability);
        prize.available = prize.quantity > 0;

        if (prize.quantity === 0) {
          prize.active = false;
          prize.probability = 0;
          prize.available = false;
    }
        
        return true;
    },
    
    deletePrize: function(branchKey, prizeId) {
        if (!this.branches[branchKey]) return false;
        
        const prizeIndex = this.branches[branchKey].prizes.findIndex(p => p.id === prizeId);
        if (prizeIndex === -1) return false;
        
        this.branches[branchKey].prizes.splice(prizeIndex, 1);
        return true;
    }
};

let currentBranch = 'batu-satu';
let editingPrizeId = null;

function showSection(sectionName) {
    // Hide all sections
    document.querySelectorAll('.section').forEach(section => {
        section.classList.remove('active');
    });
    
    // Remove active from all sidebar links
    document.querySelectorAll('.sidebar a').forEach(a => a.classList.remove('active'));
    
    // Show selected section
    document.getElementById(sectionName + 'Section').classList.add('active');
    event.target.classList.add('active');
    
    // Update page title
    const titles = {
        'dashboard': 'Dashboard',
        'prizes': 'Manage Prizes',
        'wheelSettings': 'Wheel Settings',
        'spinLogs': 'Spin Logs',
        'analytics': 'Analytics'
    };
    
    document.getElementById('pageTitle').textContent = titles[sectionName];
    
    // Save current section to localStorage
    localStorage.setItem('currentSection', sectionName);
    
    // Load section-specific data
    if (sectionName === 'prizes') {
        loadPrizesTable();
    } else if (sectionName === 'spinLogs') {
        loadWinnerHistory();
    }
}

function switchBranch() {
    currentBranch = document.getElementById('branchSelector').value;
    
    // Reload current section data
    const activeSection = document.querySelector('.section.active');
    if (activeSection) {
        const sectionName = activeSection.id.replace('Section', '');
        if (sectionName === 'prizes') {
            loadPrizesTable();
        } else if (sectionName === 'spinLogs') {
            loadWinnerHistory();
        }
    }
}

let currentFilter = 'all';

function filterPrizes(filter) {
  currentFilter = filter;

  document.querySelectorAll('[id^="filter"]').forEach(btn => {
    btn.style.background = '#ecf0f1';
    btn.style.color = '#2c3e50';
  });
  document.getElementById('filter' + filter.charAt(0).toUpperCase() + filter.slice(1)).style.background = '#3498db';
  document.getElementById('filter' + filter.charAt(0).toUpperCase() + filter.slice(1)).style.color = 'white';

  loadPrizesTable();
}

function loadPrizesTable() {
    let prizes = PRIZE_DATABASE.branches[currentBranch].prizes;
    
    // Apply filter
    if (currentFilter === 'active') {
        prizes = prizes.filter(p => p.active);
    } else if (currentFilter === 'inactive') {
        prizes = prizes.filter(p => !p.active);
    }
    
    const tableBody = document.getElementById('prizesTableBody');
    
    if (prizes.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="7" style="text-align: center;">No prizes found</td></tr>';
        return;
    }
    
    tableBody.innerHTML = prizes.map(prize => {
      const categoryClass = `category-${prize.category}`;
      const status = prize.quantity > 0 ? 'Available' : 'Out of Stock';
      const statusColor = prize.quantity > 0 ? '#27ae60' : '#e74c3c';
      const lockIcon = prize.locked ? '<span style="color: #e74c3c; font-weight: bold; font-size: 0.9rem; ">[LOCKED]</span>' : '<span style="color: #27ae60; font-weight: bold; font-size: 0.9rem; ">[UNLOCKED]</span>';
      const activeStatus = prize.active ? '<span style="color: #27ae60; font-weight: bold; font-size: 0.9rem; ">[ACTIVE]</span>' : '<span style="color: #e74c3c; font-weight: bold; font-size: 0.9rem; ">[INACTIVE]</span>';
      
      return `
          <tr>
              <td>${prize.name}</td>
              <td><span class="${categoryClass}">${prize.category.toUpperCase()}</span></td>
              <td>${prize.quantity}</td>
              <td>${prize.probability}% ${lockIcon}</td>
              <td style="color: ${statusColor}; font-weight: bold;">${status}</td>
              <td>${activeStatus}</td>
              <td>
                  <button class="btn" style="background: ${prize.active ? '#e74c3c' : '#27ae60'}; color: white;" 
                          onclick="toggleActive('${prize.id}')">${prize.active ? 'Deactivate' : 'Activate'}</button>
                  <button class="btn" style="background: ${prize.locked ? '#e74c3c' : '#f39c12'}; color: white;" 
                          onclick="toggleLock('${prize.id}')">${prize.locked ? 'Unlock' : 'Lock'}</button>
                  <button class="btn btn-warning" onclick="editPrize('${prize.id}')">Edit</button>
                  <button class="btn btn-danger" onclick="deletePrize('${prize.id}')">Delete</button>
              </td>
          </tr>
      `;
  }).join('');
    
    updateTotalProbability();
}

function updateTotalProbability() {
    const prizes = PRIZE_DATABASE.branches[currentBranch].prizes;
    const total = prizes.filter(p => p.active).reduce((sum, prize) => sum + prize.probability, 0);
    
    if (!document.getElementById('probabilityTotal')) {
        const totalDiv = document.createElement('div');
        totalDiv.id = 'probabilityTotal';
        totalDiv.style.cssText = 'margin-top: 15px; padding: 10px; background: #ecf0f1; border-radius: 5px; font-weight: bold;';
        document.getElementById('prizesSection').appendChild(totalDiv);
    }
    
    const totalElement = document.getElementById('probabilityTotal');
    const color = total === 100 ? '#27ae60' : '#e74c3c';
    totalElement.innerHTML = `Total Probability: <span style="color: ${color}">${total.toFixed(1)}%</span>`;
    
    if (total !== 100) {
        totalElement.innerHTML += ' <span style="color: #e74c3c; font-size: 0.9rem;">(Should equal 100%)</span>';
    }
     
}

// lock prizes probability
function toggleLock(prizeId) {
    const prize = PRIZE_DATABASE.branches[currentBranch].prizes.find(p => p.id === prizeId); 
    if (prize) {
        prize.locked = !prize.locked;
        saveToLocalStorage();
        loadPrizesTable();
    }
}

// toggle active/inactive button
function toggleActive(prizeId) {
  const prize = PRIZE_DATABASE.branches[currentBranch].prizes.find(p => p.id === prizeId);
  if (prize) {
    prize.active = !prize.active;
    
    if (prize.active) {
      // Activating a prize - rebalance all active prizes
      const activePrizes = PRIZE_DATABASE.branches[currentBranch].prizes.filter(p => p.active);
      
      if (activePrizes.length === 1) {
        activePrizes[0].probability = 100;
      } else {
        // Multiple active prizes - trigger auto-calculation
        autoCalculateProbabilities(prizeId, prize.probability);
      }
    } else {
      // Deactivating a prize - set its probability to 0 and rebalance others
      prize.probability = 0;
      rebalanceActivePrizes();
    }
    
    saveToLocalStorage();
    loadPrizesTable();
  }
}

// rebalancing function
function rebalanceActivePrizes() {

    prizes.forEach(prize => {
      if (prize.quantity === 0) {
          prize.active = false;
          prize.probability = 0;
          prize.available = false;
      }
  });

    const prizes = PRIZE_DATABASE.branches[currentBranch].prizes;
    const activePrizes = prizes.filter(p => p.active);
    const lockedPrizes = activePrizes.filter(p => p.locked);
    const unlockedPrizes = activePrizes.filter(p => !p.locked);
  
  if (activePrizes.length === 0) return;
  
  if (activePrizes.length === 1) {
    activePrizes[0].probability = 100;
    return;
  }
  
  // Calculate locked total
  const lockedTotal = lockedPrizes.reduce((sum, p) => sum + p.probability, 0);
  const remainingForUnlocked = 100 - lockedTotal;
  
  if (unlockedPrizes.length === 0) return;
  
  const goldPrizes = unlockedPrizes.filter(p => p.category === 'gold');
  const silverPrizes = unlockedPrizes.filter(p => p.category === 'silver');
  const compPrizes = unlockedPrizes.filter(p => p.category === 'complimentary');
  
  const goldShare = remainingForUnlocked * 0.1;
  const silverShare = remainingForUnlocked * 0.2;
  const compShare = remainingForUnlocked * 0.7;
  
  if (goldPrizes.length > 0) {
    const perGold = goldShare / goldPrizes.length;
    goldPrizes.forEach(p => p.probability = parseFloat(perGold.toFixed(1)));
  }
  
  if (silverPrizes.length > 0) {
    const perSilver = silverShare / silverPrizes.length;
    silverPrizes.forEach(p => p.probability = parseFloat(perSilver.toFixed(1)));
  }
  
  if (compPrizes.length > 0) {
    const basePerComp = compShare / compPrizes.length;
    
    // Create small variations around the base value
    const variations = [1.05, 1.03, 1.01, 1.00, 0.99, 0.97, 0.95, 0.94]; 
    
    let totalAssigned = 0;
    
    // Apply variations to all but the last prize
    for (let i = 0; i < compPrizes.length - 1; i++) {
      const variation = variations[i % variations.length] || 1.0;
      const assignedValue = parseFloat((basePerComp * variation).toFixed(1));
      compPrizes[i].probability = assignedValue;
      totalAssigned += assignedValue;
    }
    
    // Last prize gets the exact remainder to ensure total = compShare
    const lastValue = parseFloat((compShare - totalAssigned).toFixed(1));
    compPrizes[compPrizes.length - 1].probability = lastValue;
  }
}

function openAddPrizeModal() {
    document.getElementById('modalTitle').textContent = 'Add New Prize';
    document.getElementById('prizeForm').reset();
    editingPrizeId = null;
    document.getElementById('prizeModal').style.display = 'block';
}

function recalculateAll() {
  if (confirm('This will recalculate all probabilities based on hierarchy. Locked prizes will keep their values. Continue?')) {
    rebalanceActivePrizes();
    saveToLocalStorage();
    loadPrizesTable();
  }
}

function editPrize(prizeId) {
    const prize = PRIZE_DATABASE.branches[currentBranch].prizes.find(p => p.id === prizeId);
    if (!prize) return;
    
    document.getElementById('modalTitle').textContent = 'Edit Prize';
    document.getElementById('prizeName').value = prize.name;
    document.getElementById('prizeCategory').value = prize.category;
    document.getElementById('prizeQuantity').value = prize.quantity;
    document.getElementById('prizeProbability').value = prize.probability;
    
    editingPrizeId = prizeId;
    document.getElementById('prizeModal').style.display = 'block';

      document.getElementById('prizeProbability').addEventListener('input', function() {
      if (editingPrizeId) {
          const newProb = parseFloat(this.value) || 0;
          if (newProb >= 0 && newProb <= 100) {
              autoCalculateProbabilities(editingPrizeId, newProb);
              loadPrizesTable(); 
          }
      }
  });
}


function deletePrize(prizeId) {
    const prize = PRIZE_DATABASE.branches[currentBranch].prizes.find(p => p.id === prizeId);
    if (!prize) return;
    
    if (confirm(`Are you sure you want to delete "${prize.name}"?`)) {
        if (PRIZE_DATABASE.deletePrize(currentBranch, prizeId)) {
            alert('Prize deleted successfully!');
            saveToLocalStorage();
            loadPrizesTable();
        } else {
            alert('Error deleting prize.');
        }
    }
}

function closeModal() {
    document.getElementById('prizeModal').style.display = 'none';
}

function loadWinnerHistory() {
    const winners = PRIZE_DATABASE.winners.filter(w => w.branchId === currentBranch);
    const tableBody = document.getElementById('winnersTableBody');
    
    if (winners.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">No winners yet</td></tr>';
        return;
    }
    
    tableBody.innerHTML = winners.reverse().map(winner => {
        const date = new Date(winner.timestamp).toLocaleString();
        const categoryClass = `category-${getCategoryFromPrize(winner.prize)}`;
        
        return `
            <tr>
                <td>${date}</td>
                <td>${winner.customerName}</td>
                <td>${winner.prize}</td>
                <td><span class="${categoryClass}">${getCategoryFromPrize(winner.prize).toUpperCase()}</span></td>
                <td>${winner.receiptNo || 'N/A'}</td>
                <td>${winner.branch}</td>
            </tr>
        `;
    }).join('');
}

function getCategoryFromPrize(prizeName) {
    // Find category based on prize name
    for (let branch in PRIZE_DATABASE.branches) {
        const prize = PRIZE_DATABASE.branches[branch].prizes.find(p => p.name === prizeName);
        if (prize) return prize.category;
    }
    return 'complimentary'; // default
}

function refreshLogs() {
    loadWinnerHistory();
    alert('Winner history refreshed!');
}

function exportLogs() {
    const winners = PRIZE_DATABASE.winners.filter(w => w.branchId === currentBranch);
    
    if (winners.length === 0) {
        alert('No data to export');
        return;
    }
    
    const csvContent = [
        ['Date/Time', 'Customer Name', 'Prize Won', 'Category', 'Receipt No.', 'Branch'],
        ...winners.map(w => [
            new Date(w.timestamp).toLocaleString(),
            w.customerName,
            w.prize,
            getCategoryFromPrize(w.prize),
            w.receiptNo || 'N/A',
            w.branch
        ])
    ].map(row => row.join(',')).join('\n');
    
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `winners_${currentBranch}_${new Date().toISOString().split('T')[0]}.csv`;
    a.click();
    window.URL.revokeObjectURL(url);
}

function clearLogs() {
    if (confirm('Are you sure you want to clear all winner history? This cannot be undone.')) {
        PRIZE_DATABASE.winners = PRIZE_DATABASE.winners.filter(w => w.branchId !== currentBranch);
        loadWinnerHistory();
        alert('Winner history cleared!');
    }
}

// Form submission
document.getElementById('prizeForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const prizeData = {
        name: document.getElementById('prizeName').value,
        category: document.getElementById('prizeCategory').value,
        quantity: document.getElementById('prizeQuantity').value,
        probability: document.getElementById('prizeProbability').value
    };
    
    let success = false;
    
    if (editingPrizeId) {
        // For edits, auto-calculation already applied via input event
        success = PRIZE_DATABASE.updatePrize(currentBranch, editingPrizeId, prizeData);
    } else {
        // For new prizes, add then auto-calculate
        success = PRIZE_DATABASE.addPrize(currentBranch, prizeData);
        if (success) {
            const newPrize = PRIZE_DATABASE.branches[currentBranch].prizes[PRIZE_DATABASE.branches[currentBranch].prizes.length - 1];
            autoCalculateProbabilities(newPrize.id, parseFloat(prizeData.probability));
            alert('Prize added successfully!');
        }
    }
    
    if (success) {
        saveToLocalStorage();
        closeModal();
        loadPrizesTable();
    } else {
        alert('Error saving prize.');
    }
});

// Initialize
loadPrizesTable();

function addPrize() {
    openAddPrizeModal();
}

// Close modal when clicking outside
window.onclick = function(event) {
    const modal = document.getElementById('prizeModal');
    if (event.target === modal) {
        closeModal();
    }
  }

  

</script>
</body>
</html>