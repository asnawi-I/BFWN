<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Spin Wheel Admin - Enhanced Analytics</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            display: flex;
        }
        .sidebar {
            width: 220px;
            background: #222;
            color: #fff;
            height: 100vh;
            padding: 20px;
            position: fixed;
        }
        .sidebar h2 {
            margin-bottom: 30px;
        }
        .sidebar a {
            display: block;
            color: #fff;
            padding: 10px;
            margin: 5px 0;
            text-decoration: none;
            border-radius: 5px;
        }
        .sidebar a:hover, .sidebar a.active {
            background: #444;
        }
        .main {
            margin-left: 260px;
            flex: 1;
            padding: 20px;
            background: #f5f5f5;
            overflow-y: auto;
        }
        .analytics-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
        .download-buttons {
            display: flex;
            gap: 10px;
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        .btn-primary {
            background: #2196f3;
            color: white;
        }
        .btn-success {
            background: #4caf50;
            color: white;
        }
        .btn:hover {
            opacity: 0.8;
            transform: translateY(-1px);
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
            transition: transform 0.3s;
        }
        .stat-card:hover {
            transform: translateY(-2px);
        }
        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            color: #2196f3;
            margin-bottom: 10px;
        }
        .stat-label {
            font-size: 1.1em;
            color: #666;
        }
        .chart-container {
            background: white;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .chart-title {
            font-size: 1.3em;
            margin-bottom: 20px;
            color: #333;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 10px;
        }
        .winners-table {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th {
            background: #2196f3;
            color: white;
            padding: 15px;
            text-align: left;
        }
        td {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
        }
        tr:hover {
            background: #f9f9f9;
        }
        .prize-gold { color: #ffa000; font-weight: bold; }
        .prize-silver { color: #9e9e9e; font-weight: bold; }
        .prize-bronze { color: #8d6e63; font-weight: bold; }
        .spin-log {
            max-height: 300px;
            overflow-y: auto;
            background: #f8f9fa;
            border-radius: 5px;
            padding: 15px;
        }
        .spin-entry {
            padding: 8px;
            margin-bottom: 5px;
            background: white;
            border-radius: 3px;
            border-left: 3px solid #2196f3;
        }
        #status {
            background: #4caf50;
            color: white;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
            text-align: center;
        }
        .metric-trend {
            font-size: 0.9em;
            margin-top: 5px;
        }
        .trend-up { color: #4caf50; }
        .trend-down { color: #f44336; }
        
        @media print {
            .sidebar, .download-buttons { display: none; }
            .main { margin-left: 0; }
            .chart-container { page-break-inside: avoid; }
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <h2>Admin Panel</h2>
        <a href="#">Dashboard</a>
        <a href="#">Manage Prizes</a>
        <a href="#">Wheel Settings</a>
        <a href="#">Spin Logs</a>
        <a href="#" class="active">Analytics</a>
    </div>
    
    <div class="main" id="analytics-content">
        <div class="analytics-header">
            <h1>Analytics Dashboard</h1>
            <div class="download-buttons">
                <button class="btn btn-success" onclick="downloadPDF()">â¬‡ Download as PDF</button>
                <button class="btn btn-primary" onclick="exportSpinLogs()">Export Spin Logs</button>
            </div>
        </div>
        
        <div id="status">Live Analytics Connected</div>
        
        <!-- Key Metrics -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="totalSpins">0</div>
                <div class="stat-label">Total Spins</div>
                <div class="metric-trend trend-up" id="spinsToday">+12 today</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalWinners">0</div>
                <div class="stat-label">Total Winners</div>
                <div class="metric-trend trend-up" id="winnersToday">+5 today</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="avgPrizes">0.0</div>
                <div class="stat-label">Average Prizes Won/Day</div>
                <div class="metric-trend" id="prizeTrend">Last 7 days</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="avgWinners">0.0</div>
                <div class="stat-label">Average Winners/Day</div>
                <div class="metric-trend" id="winnerTrend">Last 7 days</div>
            </div>
        </div>

        <!-- Prize Distribution Chart -->
        <div class="chart-container">
            <div class="chart-title">Prize Distribution (Gold/Silver/Bronze)</div>
            <canvas id="prizeDistributionChart" width="400" height="200"></canvas>
        </div>

        <!-- Weekly Performance -->
        <div class="chart-container">
            <div class="chart-title">Weekly Performance Overview</div>
            <canvas id="activityTrendChart" width="400" height="200"></canvas>
        </div>

        <!-- Customer Engagement Metrics -->
        <div class="chart-container">
            <div class="chart-title">Customer Engagement Metrics</div>
            <canvas id="engagementChart" width="400" height="200"></canvas>
        </div>

        <!-- Recent Winners Table -->
        <div class="winners-table">
            <div class="chart-title" style="padding: 20px 25px 0;">ðŸŽ‰ Recent Winners</div>
            <table id="winnersTable">
                <thead>
                    <tr>
                        <th>Username</th>
                        <th>Prize Type</th>
                        <th>Brand</th>
                        <th>Spin Direction</th>
                        <th>Spin Speed</th>
                        <th>Time</th>
                    </tr>
                </thead>
                <tbody id="winnersTableBody">
                </tbody>
            </table>
        </div>

        <!-- Spin Logs -->
        <div class="chart-container">
            <div class="chart-title">Recent Spin Logs</div>
            <div class="spin-log" id="spinLogs">
                <!-- Spin entries will be populated here -->
            </div>
        </div>
    </div>

    <script>
        // Global data storage
        let analyticsData = {
            totalSpins: 0,
            totalWinners: 0,
            dailyStats: {},
            prizeStats: { gold: 0, silver: 0 },
            spinLogs: [],
            winners: [],
            customerVisits: 0,
            engagementMetrics: {
                avgSpinDirection: { clockwise: 0 },
                avgSpinSpeed: []
            }
        };

        // Initialize charts
        let prizeChart, trendChart, engagementChart;

        function initializeCharts() {
            // Prize Distribution Chart
            const ctx1 = document.getElementById('prizeDistributionChart').getContext('2d');
            prizeChart = new Chart(ctx1, {
                type: 'doughnut',
                data: {
                    labels: ['ðŸ¥‡ Gold Prizes', 'ðŸ¥ˆ Silver Prizes'],
                    datasets: [{
                        data: [0, 0],
                        backgroundColor: ['#ffa000', '#9e9e9e'],
                        borderWidth: 0,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { 
                            position: 'bottom',
                            labels: { padding: 20 }
                        }
                    }
                }
            });

            // Weekly Performance Chart
            const ctx2 = document.getElementById('activityTrendChart').getContext('2d');
            trendChart = new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'Total Spins',
                            data: [],
                            backgroundColor: '#2196f3',
                            borderRadius: 4,
                            borderWidth: 0
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { 
                            display: true,
                            position: 'top',
                            labels: { padding: 20 }
                        }
                    },
                    scales: {
                        y: { 
                            beginAtZero: true,
                            grid: { color: '#f0f0f0' },
                            title: {
                                display: true,
                                text: 'Number of Spins'
                            }
                        },
                        x: { 
                            grid: { display: false },
                            title: {
                                display: true,
                                text: 'Days of the Week'
                            }
                        }
                    }
                }
            });

            // Engagement Chart
            const ctx3 = document.getElementById('engagementChart').getContext('2d');
            engagementChart = new Chart(ctx3, {
                type: 'bar',
                data: {
                    labels: ['Customer Visits', 'Total Spins', 'Avg Speed (RPM)'],
                    datasets: [{
                        data: [0, 0, 0],
                        backgroundColor: ['#2196f3', '#4caf50', '#ff9800'],
                        borderRadius: 4,
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { 
                            beginAtZero: true,
                            grid: { color: '#f0f0f0' }
                        },
                        x: { 
                            grid: { display: false }
                        }
                    }
                }
            });
        }

        function updateAnalytics() {
            // Update key metrics
            document.getElementById('totalSpins').textContent = analyticsData.totalSpins;
            document.getElementById('totalWinners').textContent = analyticsData.totalWinners;
            
            // Calculate averages
            const days = Object.keys(analyticsData.dailyStats).length || 1;
            const avgPrizes = (analyticsData.totalWinners / days).toFixed(1);
            const avgWinners = (analyticsData.totalWinners / days).toFixed(1);
            
            document.getElementById('avgPrizes').textContent = avgPrizes;
            document.getElementById('avgWinners').textContent = avgWinners;

            // Update charts
            if (prizeChart) {
                prizeChart.data.datasets[0].data = [
                    analyticsData.prizeStats.gold,
                    analyticsData.prizeStats.silver
                ];
                prizeChart.update();
            }

            if (trendChart) {
                const last7Days = [];
                const today = new Date();
                
                // Generate last 7 days
                for (let i = 6; i >= 0; i--) {
                    const date = new Date(today);
                    date.setDate(date.getDate() - i);
                    const dayName = date.toLocaleDateString('en-US', { weekday: 'short' });
                    const dateKey = date.toLocaleDateString();
                    
                    last7Days.push({
                        day: dayName,
                        spins: analyticsData.dailyStats[dateKey]?.spins || 0
                    });
                }

                trendChart.data.labels = last7Days.map(d => d.day);
                trendChart.data.datasets[0].data = last7Days.map(d => d.spins);
                trendChart.update();
            }

            if (engagementChart) {
                const avgSpeed = analyticsData.engagementMetrics.avgSpinSpeed.length > 0 
                    ? analyticsData.engagementMetrics.avgSpinSpeed.reduce((a, b) => a + b, 0) / analyticsData.engagementMetrics.avgSpinSpeed.length 
                    : 0;

                engagementChart.data.datasets[0].data = [
                    analyticsData.customerVisits,
                    analyticsData.totalSpins,
                    Math.round(avgSpeed)
                ];
                engagementChart.update();
            }
        }

        function addSpinLog(username, prize, speed) {
            const now = new Date();
            const dateKey = now.toLocaleDateString();
            const timeStamp = now.toLocaleString();

            // Update analytics data
            analyticsData.totalSpins++;
            analyticsData.customerVisits++;

            // Update daily stats
            if (!analyticsData.dailyStats[dateKey]) {
                analyticsData.dailyStats[dateKey] = { spins: 0, winners: 0 };
            }
            analyticsData.dailyStats[dateKey].spins++;
            analyticsData.dailyStats[dateKey].winners++; // Everyone wins

            // Track engagement metrics (clockwise only)
            analyticsData.engagementMetrics.avgSpinDirection.clockwise++;
            analyticsData.engagementMetrics.avgSpinSpeed.push(speed);

            // Everyone is a winner
            analyticsData.totalWinners++;

            // Categorize prize
            const prizeType = getPrizeType(prize);
            analyticsData.prizeStats[prizeType]++;

            // Add to winners table
            addWinnerToTable(username, prize, prizeType, speed, timeStamp);

            // Add to spin logs
            const logEntry = {
                username,
                prize,
                speed,
                timestamp: timeStamp
            };
            analyticsData.spinLogs.unshift(logEntry);
            
            // Keep only latest 50 logs
            if (analyticsData.spinLogs.length > 50) {
                analyticsData.spinLogs.pop();
            }

            updateSpinLogsDisplay();
            updateAnalytics();
        }

        function getPrizeType(prize) {
            const goldPrizes = ['MacBook', 'iPhone', 'Gold Voucher', 'Premium Gift Card'];
            
            if (goldPrizes.some(p => prize.includes(p))) return 'gold';
            return 'silver'; // Everything else is silver
        }

        function addWinnerToTable(username, prize, prizeType, speed, timestamp) {
            const tbody = document.getElementById('winnersTableBody');
            const row = tbody.insertRow(0);
            
            const prizeClass = `prize-${prizeType}`;
            row.innerHTML = `
                <td>${username}</td>
                <td class="${prizeClass}">${prize}</td>
                <td>${getBrand()}</td>
                <td>Clockwise</td>
                <td>${speed} RPM</td>
                <td>${timestamp}</td>
            `;

            // Keep only latest 15 winners
            while (tbody.rows.length > 15) {
                tbody.deleteRow(tbody.rows.length - 1);
            }
        }

        function updateSpinLogsDisplay() {
            const logsContainer = document.getElementById('spinLogs');
            logsContainer.innerHTML = '';

            analyticsData.spinLogs.slice(0, 15).forEach(log => {
                const entry = document.createElement('div');
                entry.className = 'spin-entry';
                entry.innerHTML = `
                    <strong>${log.username}</strong> spun at ${log.speed} RPM 
                    <span class="prize-gold">ðŸŽ‰ Won: ${log.prize}</span>
                    <small style="float: right;">${log.timestamp}</small>
                `;
                logsContainer.appendChild(entry);
            });
        }

        function getBrand() {
            const brands = ['Starbucks', 'KFC', 'Nike', 'McDonald\'s', 'Apple', 'Samsung'];
            return brands[Math.floor(Math.random() * brands.length)];
        }

        function downloadPDF() {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');
            
            // Add title
            pdf.setFontSize(20);
            pdf.text('Spin Wheel Analytics Report', 20, 20);
            
            // Add timestamp
            pdf.setFontSize(12);
            pdf.text(`Generated: ${new Date().toLocaleString()}`, 20, 35);
            
            // Add key metrics
            pdf.setFontSize(16);
            pdf.text('Key Metrics:', 20, 50);
            
            pdf.setFontSize(12);
            pdf.text(`Total Spins: ${analyticsData.totalSpins}`, 20, 65);
            pdf.text(`Total Winners: ${analyticsData.totalWinners}`, 20, 75);
            pdf.text(`Customer Visits: ${analyticsData.customerVisits}`, 20, 85);
            
            const days = Object.keys(analyticsData.dailyStats).length || 1;
            pdf.text(`Average Prizes Won/Day: ${(analyticsData.totalWinners / days).toFixed(1)}`, 20, 95);
            pdf.text(`Average Winners/Day: ${(analyticsData.totalWinners / days).toFixed(1)}`, 20, 105);
            
            // Add prize distribution
            pdf.text('Prize Distribution:', 20, 125);
            pdf.text(`Gold Prizes: ${analyticsData.prizeStats.gold}`, 30, 135);
            pdf.text(`Silver Prizes: ${analyticsData.prizeStats.silver}`, 30, 145);
            
            pdf.save('spin-wheel-analytics.pdf');
        }

        function exportSpinLogs() {
            const csvContent = "data:text/csv;charset=utf-8," 
                + "Username,Prize,Speed,Timestamp\n"
                + analyticsData.spinLogs.map(log => 
                    `${log.username},${log.prize},${log.speed},${log.timestamp}`
                ).join("\n");
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "spin_logs.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Simulate live data
        function simulateLiveData() {
            const users = ["Alice", "Bob", "Charlie", "Dana", "Eve", "Frank"];
            const prizes = ["Free Coffee", "Gift Card", "Headphones", "T-Shirt", "MacBook", "iPhone"];
            
            setInterval(() => {
                const username = users[Math.floor(Math.random() * users.length)];
                const speed = Math.floor(Math.random() * 150) + 75; // 75-225 RPM
                const prize = prizes[Math.floor(Math.random() * prizes.length)];
                
                addSpinLog(username, prize, speed);
            }, 4000);
        }

        // Initialize everything
        window.addEventListener('load', () => {
            initializeCharts();
            simulateLiveData();
            
            // Add some initial data
            setTimeout(() => {
                for (let i = 0; i < 8; i++) {
                    const users = ["Alice", "Bob", "Charlie", "Dana"];
                    const prizes = ["Free Coffee", "Gift Card", "Headphones", "MacBook"];
                    
                    addSpinLog(
                        users[Math.floor(Math.random() * users.length)],
                        prizes[Math.floor(Math.random() * prizes.length)],
                        Math.floor(Math.random() * 120) + 80
                    );
                }
            }, 1000);
        });
    </script>
</body>
</html>