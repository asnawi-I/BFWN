<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Spin Wheel Admin - Enhanced Analytics</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      display: flex;
    }
    .sidebar {
      width: 220px;
      background: #222;
      color: #fff;
      height: 100vh;
      padding: 20px;
      position: fixed;
    }
    .sidebar h2 {
      margin-bottom: 30px;
    }
    .sidebar a {
      display: block;
      color: #fff;
      padding: 10px;
      margin: 5px 0;
      text-decoration: none;
      border-radius: 5px;
    }
    .sidebar a:hover, .sidebar a.active {
      background: #444;
    }
    .main {
      margin-left: 260px;
      flex: 1;
      padding: 20px;
      background: #f5f5f5;
      overflow-y: auto;
    }
    .analytics-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
    }
    .download-buttons {
      display: flex;
      gap: 10px;
    }
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s;
    }
    .btn-primary {
      background: #2196f3;
      color: white;
    }
    .btn-success {
      background: #4caf50;
      color: white;
    }
    .btn:hover {
      opacity: 0.8;
      transform: translateY(-1px);
    }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    .stat-card {
      background: white;
      padding: 25px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      text-align: center;
      transition: transform 0.3s;
    }
    .stat-card:hover {
      transform: translateY(-2px);
    }
    .stat-number {
      font-size: 2.5em;
      font-weight: bold;
      color: #2196f3;
      margin-bottom: 10px;
    }
    .stat-label {
      font-size: 1.1em;
      color: #666;
    }
    .chart-container {
      background: white;
      padding: 25px;
      border-radius: 10px;
      margin-bottom: 30px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      text-align: center;
    }
    .chart-title {
      font-size: 1.3em;
      margin-bottom: 20px;
      color: #333;
      border-bottom: 2px solid #f0f0f0;
      padding-bottom: 10px;
    }
    .winners-table {
      background: white;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th {
      background: #2196f3;
      color: white;
      padding: 15px;
      text-align: left;
    }
    td {
      padding: 12px 15px;
      border-bottom: 1px solid #eee;
    }
    tr:hover {
      background: #f9f9f9;
    }
    .prize-gold { color: #ffa000; font-weight: bold; }
    .prize-silver { color: #9e9e9e; font-weight: bold; }
    .prize-complementary { color: #4caf50; font-weight: bold; }
    .spin-log {
      max-height: 300px;
      overflow-y: auto;
      background: #f8f9fa;
      border-radius: 5px;
      padding: 15px;
    }
    .spin-entry {
      padding: 8px;
      margin-bottom: 5px;
      background: white;
      border-radius: 3px;
      border-left: 3px solid #2196f3;
    }
    #status {
      background: #4caf50;
      color: white;
      padding: 10px;
      border-radius: 5px;
      margin-bottom: 20px;
      text-align: center;
    }
    .metric-trend {
      font-size: 0.9em;
      margin-top: 5px;
    }
    .trend-up { color: #4caf50; }
    .trend-down { color: #f44336; }
    
    @media print {
      .sidebar, .download-buttons { display: none; }
      .main { margin-left: 0; }
      .chart-container { page-break-inside: avoid; }
    }
  </style>
</head>
<body>
  <div class="sidebar">
    <h2>Admin Panel</h2>
    <a href="#">Dashboard</a>
    <a href="#">Manage Prizes</a>
    <a href="#">Wheel Settings</a>
    <a href="#">Spin Logs</a>
    <a href="#" class="active">Analytics</a>
  </div>
  
  <div class="main" id="analytics-content">
    <div class="analytics-header">
      <h1>Analytics Dashboard</h1>
      <div class="download-buttons">
        <button class="btn btn-success" onclick="downloadPDF()">‚¨á Download as PDF</button>
        <button class="btn btn-primary" onclick="exportSpinLogs()">Export Spin Logs</button>
      </div>
    </div>
    
    <div id="status">Live Analytics Connected</div>
    
    <!-- Key Metrics -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-number" id="totalSpins">0</div>
        <div class="stat-label">Total Spins</div>
        <div class="metric-trend trend-up" id="spinsToday">+0 today</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="totalWinners">0</div>
        <div class="stat-label">Total Winners</div>
        <div class="metric-trend trend-up" id="winnersToday">+0 today</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="avgPrizes">0.0</div>
        <div class="stat-label">Average Prizes Won/Day</div>
        <div class="metric-trend" id="prizeTrend">Last 7 days</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="avgWinners">0.0</div>
        <div class="stat-label">Average Winners/Day</div>
        <div class="metric-trend" id="winnerTrend">Last 7 days</div>
      </div>
    </div>

    <!-- Prize Distribution Chart -->
    <div class="chart-container">
      <div class="chart-title">Prize Distribution (Gold / Silver / Complementary)</div>
      <canvas id="prizeDistributionChart" width="250" height="250"></canvas>
    </div>

    <!-- Weekly Performance -->
    <div class="chart-container">
      <div class="chart-title">Weekly Performance Overview</div>
      <canvas id="activityTrendChart" width="400" height="200"></canvas>
    </div>

    <!-- Customer Engagement Metrics -->
    <div class="chart-container">
      <div class="chart-title">Customer Engagement Metrics</div>
      <canvas id="engagementChart" width="400" height="200"></canvas>
    </div>

    <!-- Recent Winners Table -->
    <div class="winners-table">
      <div class="chart-title" style="padding: 20px 25px 0;">üéâ Recent Winners</div>
      <table id="winnersTable">
        <thead>
          <tr>
            <th>Username</th>
            <th>Prize Type</th>
            <th>Brand</th>
            <th>Spin Direction</th>
            <th>Spin Speed</th>
            <th>Time</th>
          </tr>
        </thead>
        <tbody id="winnersTableBody"></tbody>
      </table>
    </div>

    <!-- Spin Logs -->
    <div class="chart-container">
      <div class="chart-title">Recent Spin Logs</div>
      <div class="spin-log" id="spinLogs"></div>
    </div>
  </div>

  <script>
    let analyticsData = {
      totalSpins: 0,
      totalWinners: 0,
      dailyStats: {},
      prizeStats: { gold: 0, silver: 0, complementary: 0 },
      spinLogs: [],
      winners: [],
      customerVisits: 0,
      engagementMetrics: {
        avgSpinDirection: { clockwise: 0 },
        avgSpinSpeed: []
      }
    };

    let prizeChart, trendChart, engagementChart;

    function initializeCharts() {
      // Prize Distribution Chart
      const ctx1 = document.getElementById('prizeDistributionChart').getContext('2d');
      prizeChart = new Chart(ctx1, {
        type: 'doughnut',
        data: {
          labels: ['ü•á Gold', 'ü•à Silver', 'üéÅ Complementary'],
          datasets: [{
            data: [0, 0, 0],
            backgroundColor: ['#ffa000', '#9e9e9e', '#4caf50'],
            borderWidth: 0,
            hoverOffset: 4
          }]
        },
        options: {
          responsive: true,
          cutout: '65%',
          plugins: {
            legend: { position: 'bottom', labels: { padding: 15 } }
          }
        }
      });

      // Weekly Performance Chart
      const ctx2 = document.getElementById('activityTrendChart').getContext('2d');
      trendChart = new Chart(ctx2, {
        type: 'bar',
        data: { labels: [], datasets: [{ label: 'Total Spins', data: [], backgroundColor: '#2196f3', borderRadius: 4 }] },
        options: { responsive: true, scales: { y: { beginAtZero: true } } }
      });

      // Engagement Chart
      const ctx3 = document.getElementById('engagementChart').getContext('2d');
      engagementChart = new Chart(ctx3, {
        type: 'bar',
        data: {
          labels: ['Customer Visits', 'Total Spins', 'Avg Speed (RPM)'],
          datasets: [{ data: [0, 0, 0], backgroundColor: ['#2196f3', '#4caf50', '#ff9800'], borderRadius: 4 }]
        },
        options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
      });
    }

    function getPrizeType(prize) {
      if (prize.includes('Gold')) return 'gold';
      if (prize.includes('Silver')) return 'silver';
      return 'complementary';
    }

    function addSpinLog(username, prize, speed) {
      const now = new Date();
      const dateKey = now.toLocaleDateString();
      const timeStamp = now.toLocaleString();

      analyticsData.totalSpins++;
      analyticsData.customerVisits++;

      if (!analyticsData.dailyStats[dateKey]) {
        analyticsData.dailyStats[dateKey] = { spins: 0, winners: 0 };
      }
      analyticsData.dailyStats[dateKey].spins++;
      analyticsData.dailyStats[dateKey].winners++;

      analyticsData.engagementMetrics.avgSpinDirection.clockwise++;
      analyticsData.engagementMetrics.avgSpinSpeed.push(speed);

      analyticsData.totalWinners++;
      const prizeType = getPrizeType(prize);
      analyticsData.prizeStats[prizeType]++;

      const tbody = document.getElementById('winnersTableBody');
      const row = tbody.insertRow(0);
      row.innerHTML = `
        <td>${username}</td>
        <td class="prize-${prizeType}">${prize}</td>
        <td>${getBrand()}</td>
        <td>Clockwise</td>
        <td>${speed} RPM</td>
        <td>${timeStamp}</td>`;
      while (tbody.rows.length > 15) tbody.deleteRow(tbody.rows.length - 1);

      analyticsData.spinLogs.unshift({ username, prize, speed, timestamp: timeStamp });
      if (analyticsData.spinLogs.length > 50) analyticsData.spinLogs.pop();

      updateSpinLogsDisplay();
      updateAnalytics();
    }

    function updateSpinLogsDisplay() {
      const logsContainer = document.getElementById('spinLogs');
      logsContainer.innerHTML = '';
      analyticsData.spinLogs.slice(0, 15).forEach(log => {
        const entry = document.createElement('div');
        entry.className = 'spin-entry';
        entry.innerHTML = `<strong>${log.username}</strong> spun at ${log.speed} RPM <span class="prize-gold">üéâ Won: ${log.prize}</span><small style="float: right;">${log.timestamp}</small>`;
        logsContainer.appendChild(entry);
      });
    }

    function getBrand() {
      const brands = ['Starbucks', 'KFC', 'Nike', 'Apple', 'Samsung'];
      return brands[Math.floor(Math.random() * brands.length)];
    }

    function updateAnalytics() {
      document.getElementById('totalSpins').textContent = analyticsData.totalSpins;
      document.getElementById('totalWinners').textContent = analyticsData.totalWinners;

      const days = Object.keys(analyticsData.dailyStats).length || 1;
      document.getElementById('avgPrizes').textContent = (analyticsData.totalWinners / days).toFixed(1);
      document.getElementById('avgWinners').textContent = (analyticsData.totalWinners / days).toFixed(1);

      prizeChart.data.datasets[0].data = [
        analyticsData.prizeStats.gold,
        analyticsData.prizeStats.silver,
        analyticsData.prizeStats.complementary
      ];
      prizeChart.update();

      const last7Days = [];
      const today = new Date();
      for (let i = 6; i >= 0; i--) {
        const date = new Date(today);
        date.setDate(date.getDate() - i);
        const dayName = date.toLocaleDateString('en-US', { weekday: 'short' });
        const dateKey = date.toLocaleDateString();
        last7Days.push({ day: dayName, spins: analyticsData.dailyStats[dateKey]?.spins || 0 });
      }
      trendChart.data.labels = last7Days.map(d => d.day);
      trendChart.data.datasets[0].data = last7Days.map(d => d.spins);
      trendChart.update();

      const avgSpeed = analyticsData.engagementMetrics.avgSpinSpeed.length > 0
        ? analyticsData.engagementMetrics.avgSpinSpeed.reduce((a, b) => a + b, 0) / analyticsData.engagementMetrics.avgSpinSpeed.length
        : 0;
      engagementChart.data.datasets[0].data = [analyticsData.customerVisits, analyticsData.totalSpins, Math.round(avgSpeed)];
      engagementChart.update();
    }

    function simulateLiveData() {
      const users = ["Alice", "Bob", "Charlie", "Dana", "Eve", "Frank"];
      const prizes = ["Gold Prize", "Silver Prize", "Complementary Gift"];
      setInterval(() => {
        const day = new Date().getDay(); // 0=Sun, 5=Fri, 6=Sat
        if (![0, 5, 6].includes(day)) return;
        const username = users[Math.floor(Math.random() * users.length)];
        const speed = Math.floor(Math.random() * 150) + 75;
        const prize = prizes[Math.floor(Math.random() * prizes.length)];
        addSpinLog(username, prize, speed);
      }, 4000);
    }

    window.addEventListener('load', () => {
      initializeCharts();
      simulateLiveData();
    });
  </script>
</body>
</html>
