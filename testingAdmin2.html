<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Spin Wheel Admin</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; display: flex; }
    .sidebar { width: 220px; background: #222; color: #fff; height: 100vh; padding: 20px; }
    .sidebar h2 { margin-bottom: 30px; }
    .sidebar a { display: block; color: #fff; padding: 10px; margin: 5px 0; text-decoration: none; border-radius: 5px; }
    .sidebar a:hover { background: #444; }
    .main { flex: 1; padding: 20px; background: #f5f5f5; overflow-y: auto; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; background: #fff; }
    table, th, td { border: 1px solid #ccc; }
    th, td { padding: 10px; text-align: left; }
    button { padding: 6px 12px; margin: 2px; cursor: pointer; }
    #status { margin-top: 10px; font-size: 14px; color: green; }
    .section { margin-bottom: 40px; }
    .form-inline input { padding: 6px; margin-right: 5px; }
    canvas { background: #fff; border: 1px solid #ccc; border-radius: 8px; margin-top: 20px; }
  </style>
</head>
<body>
  <div class="sidebar">
    <h2>Admin Panel</h2>
    <a href="#">Dashboard</a>
    <a href="#">Manage Prizes</a>
    <a href="#">Wheel Settings</a>
    <a href="#">Spin Logs</a>
    <a href="#">Analytics</a>
  </div>

  <div class="main">
    <h1>Spin Wheel Admin</h1>
    <div id="status">🔄 Connecting to live updates...</div>

    <!-- 🎁 Prize Inventory -->
    <div class="section">
      <h2>Manage Prizes</h2>
      <div class="form-inline">
        <input type="text" id="prizeName" placeholder="Prize Name">
        <input type="number" id="probability" placeholder="Probability %">
        <input type="number" id="quantity" placeholder="Quantity">
        <button onclick="addPrize()">+ Add Prize</button>
      </div>
      <button onclick="downloadPDF()">⬇ Download as PDF</button>
      <table id="prizeTable">
        <tr>
          <th>Prize Name</th>
          <th>Probability (%)</th>
          <th>Original Qty</th>
          <th>Remaining</th>
          <th>Actions</th>
        </tr>
        <tr>
          <td>Free Coffee</td>
          <td>30%</td>
          <td>50</td>
          <td id="left-1">50</td>
          <td>
            <button onclick="editPrize(this)">Edit</button>
            <button onclick="deletePrize(this)">Delete</button>
          </td>
        </tr>
        <tr>
          <td>Gift Voucher</td>
          <td>10%</td>
          <td>20</td>
          <td id="left-2">20</td>
          <td>
            <button onclick="editPrize(this)">Edit</button>
            <button onclick="deletePrize(this)">Delete</button>
          </td>
        </tr>
      </table>
    </div>

    <!-- 🏆 Winner Logs -->
    <div class="section">
      <h2>Winners Log</h2>
      <table id="winnerTable">
        <tr>
          <th>Username</th>
          <th>Prize</th>
          <th>Brand</th>
          <th>Time</th>
        </tr>
      </table>
    </div>

    <!-- 📊 Analytics -->
    <div class="section">
      <h2>Analytics (Prizes Won)</h2>
      <canvas id="prizeChart" width="400" height="200"></canvas>
      <canvas id="trendChart" width="400" height="200"></canvas>
    </div>
  </div>

  <script>
    let prizeTable = document.getElementById("prizeTable");
    let winnerTable = document.getElementById("winnerTable");
    let statusEl = document.getElementById("status");

    // Track stats
    let prizeStats = {};  // { prizeName: count }
    let dailyStats = {};  // { date: count }

    // ✅ Add Prize
    function addPrize() {
      let name = document.getElementById("prizeName").value;
      let prob = document.getElementById("probability").value;
      let qty = document.getElementById("quantity").value;

      if (!name || !prob || !qty) {
        alert("Please fill all fields!");
        return;
      }

      let row = prizeTable.insertRow(-1);
      row.innerHTML = `
        <td>${name}</td>
        <td>${prob}%</td>
        <td>${qty}</td>
        <td>${qty}</td>
        <td>
          <button onclick="editPrize(this)">Edit</button>
          <button onclick="deletePrize(this)">Delete</button>
        </td>
      `;

      document.getElementById("prizeName").value = "";
      document.getElementById("probability").value = "";
      document.getElementById("quantity").value = "";
    }

    // ✅ Edit Prize
    function editPrize(btn) {
      let row = btn.parentNode.parentNode;
      let name = prompt("Edit prize name:", row.cells[0].innerText);
      let prob = prompt("Edit probability (%):", row.cells[1].innerText.replace("%",""));
      let qty = prompt("Edit quantity:", row.cells[2].innerText);

      if (name && prob && qty) {
        row.cells[0].innerText = name;
        row.cells[1].innerText = prob + "%";
        row.cells[2].innerText = qty;
        row.cells[3].innerText = qty;
      }
    }

    // ✅ Delete Prize
    function deletePrize(btn) {
      let row = btn.parentNode.parentNode;
      row.remove();
    }

    // ✅ Add Winner Log (called whenever someone wins)
    function addWinner(username, prize, brand) {
      let now = new Date().toLocaleString();
      let dateKey = new Date().toLocaleDateString();

      let row = winnerTable.insertRow(-1);
      row.innerHTML = `<td>${username}</td><td>${prize}</td><td>${brand}</td><td>${now}</td>`;

      // reduce remaining qty in prize table
      for (let i = 1; i < prizeTable.rows.length; i++) {
        if (prizeTable.rows[i].cells[0].innerText === prize) {
          let leftCell = prizeTable.rows[i].cells[3];
          leftCell.innerText = Math.max(0, parseInt(leftCell.innerText) - 1);
        }
      }

      // update stats
      prizeStats[prize] = (prizeStats[prize] || 0) + 1;
      dailyStats[dateKey] = (dailyStats[dateKey] || 0) + 1;

      updateCharts();
    }

    // ✅ Download as PDF (quick solution)
    function downloadPDF() {
      window.print();
    }

    // ✅ Charts
    let ctx1 = document.getElementById("prizeChart").getContext("2d");
    let ctx2 = document.getElementById("trendChart").getContext("2d");

    let prizeChart = new Chart(ctx1, {
      type: 'pie',
      data: { labels: [], datasets: [{ data: [], backgroundColor: ["#4caf50", "#2196f3", "#ff9800", "#e91e63", "#9c27b0"] }] },
      options: { responsive: true, plugins: { legend: { position: "bottom" } } }
    });

    let trendChart = new Chart(ctx2, {
      type: 'bar',
      data: { labels: [], datasets: [{ label: "Winners per Day", data: [], backgroundColor: "#2196f3" }] },
      options: { responsive: true }
    });

    function updateCharts() {
      // Update Prize Chart
      prizeChart.data.labels = Object.keys(prizeStats);
      prizeChart.data.datasets[0].data = Object.values(prizeStats);
      prizeChart.update();

      // Update Trend Chart
      trendChart.data.labels = Object.keys(dailyStats);
      trendChart.data.datasets[0].data = Object.values(dailyStats);
      trendChart.update();
    }

    // ✅ Simulate Live Updates
    function connectWebSocket() {
      statusEl.textContent = "✅ Connected to live updates";

      setInterval(() => {
        let users = ["Alice", "Bob", "Charlie", "Dana"];
        let brands = ["Starbucks", "KFC", "Nike", "Adidas"];
        let prizes = ["Free Coffee", "Gift Voucher"];

        let winner = users[Math.floor(Math.random() * users.length)];
        let prize = prizes[Math.floor(Math.random() * prizes.length)];
        let brand = brands[Math.floor(Math.random() * brands.length)];

        addWinner(winner, prize, brand);
      }, 5000);
    }

    connectWebSocket();
  </script>
</body>
</html>
